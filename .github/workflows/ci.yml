name: CI

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  unit:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - name: Run Unit Tests
        run: go test -v -short ./...

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

      nats:
        image: nats:latest
        ports:
          - 4222:4222

      redpanda:
        image: redpandadata/redpanda:latest
        ports:
          - 9092:9092
        options: >-
          --health-cmd "rpk cluster health"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      
      - name: Run Integration Tests
        run: go test -v -tags=integration ./...
        env:
          WARP_TEST_REDIS_ADDR: localhost:6379
          WARP_TEST_NATS_ADDR: localhost:4222
          WARP_TEST_KAFKA_ADDR: localhost:9092
          WARP_TEST_FORCE_REAL: true

  benchmark:
    name: Benchmarks
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      
      - name: Run Benchmarks
        run: go run cmd/bench/main.go -target=warp-local,warp-redis,ristretto,redis > benchmark_results.txt
        env:
          WARP_TEST_REDIS_ADDR: localhost:6379

      - name: Upload Benchmark Results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.txt
          if-no-files-found: error

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [unit, integration, benchmark]
    if: startsWith(github.ref, 'refs/tags/v') && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      
      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v5
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
